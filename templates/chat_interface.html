<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ED19024 AI Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; overflow: hidden;
        }
        
        .app { height: 100vh; }
        
        .topbar {
            width: 100%; display: flex; justify-content: flex-end; align-items: center;
            background: rgba(255,255,255,0.1); padding: 16px 30px; position: relative;
        }
        
        .configure-link {
            color: #3b82f6; background: white; border-radius: 6px; padding: 8px 18px;
            font-size: 14px; font-weight: 500; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.2s;
        }
        
        .configure-link:hover {
            background: #e0e7ef;
        }
        
        .main-content {
            width: 100vw; height: calc(100vh - 56px); display: flex; flex-direction: column;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
        }
        
        .chat-header {
            padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.5);
        }
        
        .chat-title { font-size: 24px; font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .chat-subtitle { color: #6b7280; font-size: 14px; }
        
        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px 30px;
            display: flex; flex-direction: column; gap: 20px;
        }
        
        .welcome {
            text-align: center; color: #6b7280; margin-top: 50px;
        }
        
        .welcome h2 { color: #1f2937; margin-bottom: 10px; }
        
        .message {
            display: flex; gap: 15px; animation: fadeIn 0.3s ease;
        }
        
        .message.user { flex-direction: row-reverse; }
        
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px; flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
        }
        
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;
        }
        
        .message-content { flex: 1; max-width: calc(100% - 55px); }
        
        .message-bubble {
            background: white; border-radius: 18px; padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; margin-left: 60px;
        }
        
        .message-text { line-height: 1.5; word-wrap: break-word; }
        
        .message-sources {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .sources-label { font-size: 12px; color: #6b7280; font-weight: 500; margin-bottom: 8px; }
        
        .source-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .source-tag {
            background: rgba(59,130,246,0.1); color: #3b82f6; padding: 4px 8px;
            border-radius: 12px; font-size: 11px; font-weight: 500;
        }
        
        .message-timestamp {
            color: rgba(0,0,0,0.4); font-size: 11px; margin-top: 8px;
        }
        
        .message.user .message-timestamp { color: rgba(255,255,255,0.7); }
        
        .input-container {
            padding: 20px 30px; border-top: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
        }
        
        .input-wrapper { position: relative; max-width: 800px; margin: 0 auto; }
        
        .message-input {
            width: 100%; border: 2px solid rgba(0,0,0,0.1); border-radius: 25px;
            padding: 15px 60px 15px 20px; font-size: 16px; background: white;
            outline: none; resize: none; min-height: 50px; max-height: 120px;
            font-family: inherit;
        }
        
        .message-input:focus {
            border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .send-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 40px; height: 40px; border: none; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        
        .send-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .typing {
            display: none; align-items: center; gap: 8px; color: #6b7280;
            font-style: italic; margin-top: 10px;
        }
        
        .typing-dots { display: flex; gap: 4px; }
        
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #6b7280;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 12px 20px;
            border-radius: 8px; z-index: 10000; color: white; font-size: 14px;
            animation: slideIn 0.3s ease; max-width: 300px;
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        .notification.info { background: #3b82f6; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .source-list {
            margin: 8px 0 0 0;
            padding-left: 18px;
            color: #3b82f6;
            font-size: 12px;
        }
        .source-list li {
            margin-bottom: 2px;
            list-style-type: disc;
            background: none;
            display: list-item;
            padding: 0;
            border-radius: 0;
        }
        .contract-viewer-section {
            width: 100%; max-width: 900px; margin: 0 auto 18px auto; display: flex; flex-direction: column; align-items: center;
        }
        .contract-viewer-label {
            color: #1f2937; font-size: 15px; font-weight: 600; margin-bottom: 6px; margin-top: 10px;
        }
        .contract-viewer {
            width: 100%;
            height: 600px;
            min-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            margin-bottom: 8px;
            display: block;
        }
        .contract-placeholder {
            color: #ef4444; font-size: 15px; text-align: center; margin: 20px 0;
        }
        .contract-viewer-top {
            width: 100vw;
            max-width: 100vw;
            margin: 0 auto 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 12px rgba(0,0,0,0.03);
            padding: 0 0 0 0;
        }
        @media (max-width: 900px) {
            .contract-viewer-top { max-width: 100vw; }
            .contract-viewer { height: 400px; }
        }
        .contract-link {
            color: #3b82f6; background: white; border-radius: 6px; padding: 8px 18px;
            font-size: 14px; font-weight: 500; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.2s; margin-right: 12px;
        }
        .contract-link:hover {
            background: #e0e7ef;
        }
        
        /* Chat History Menu Styles */
        .chat-history-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .chat-history-menu.show {
            display: block;
        }
        
        .chat-history-menu button {
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #1f2937;
            transition: background 0.2s;
        }
        
        .chat-history-menu button:hover {
            background: #f3f4f6;
        }
        
        .chat-history-menu button.danger {
            color: #ef4444;
        }
        
        .chat-history-menu button.danger:hover {
            background: #fee2e2;
        }
        
        .chat-history-menu .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }
        
        .chat-history-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <a href="/contract" class="contract-link">📄 View Contract</a>
            <div class="chat-history-container">
                <button class="configure-link" onclick="showChatHistoryMenu()" style="border: none; cursor: pointer; margin-right: 12px;">💬 History</button>
                <div class="chat-history-menu" id="chatHistoryMenu">
                    <button onclick="exportChatHistory()">📤 Export History</button>
                    <button onclick="importChatHistory()">📥 Import History</button>
                    <div class="divider"></div>
                    <button onclick="clearChatHistory()" class="danger">🗑️ Clear History</button>
                </div>
            </div>
            <a href="/configure" class="configure-link">⚙️ Configure</a>
        </div>
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title">ED19024 AI Assistant</div>
                <div class="chat-subtitle">Ask questions about ED19024</div>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="welcome" id="welcomeMessage">
                    <h2>⚖️ Welcome to your ED19024 AI Assistant</h2>
                    <p>Upload ED19024 using the Configure page and start asking questions about their content.</p>
                </div>
            </div>
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="Ask a question about your legal documents..." 
                              rows="1"></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                        </svg>
                    </button>
                </div>
                <div class="typing" id="typingIndicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced chat interface with persistent history
        console.log('⚖️ Starting Legal Document AI Assistant with persistent chat history...');

        // Global variables
        let isTyping = false;
        let conversationHistory = [];
        let sessionId = null;

        // DOM elements
        let elements = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 DOM loaded, initializing with persistent history...');
            initializeApp();
        });

        function initializeApp() {
            try {
                // Get DOM elements
                elements = {
                    chatContainer: document.getElementById('chatContainer'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    welcomeMessage: document.getElementById('welcomeMessage'),
                    typingIndicator: document.getElementById('typingIndicator'),
                };
                
                console.log('✅ Elements found:', {
                    chatContainer: !!elements.chatContainer,
                    messageInput: !!elements.messageInput,
                    sendButton: !!elements.sendButton,
                    welcomeMessage: !!elements.welcomeMessage,
                    typingIndicator: !!elements.typingIndicator
                });
                
                bindEvents();
                console.log('✅ Events bound');
                loadInitialData();
                console.log('✅ Loading initial data and chat history...');
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                showNotification('Failed to initialize app: ' + error.message, 'error');
            }
        }

        function bindEvents() {
            elements.messageInput.addEventListener('input', handleInputChange);
            elements.messageInput.addEventListener('keydown', handleKeyDown);
            elements.sendButton.addEventListener('click', sendMessage);
        }

        async function loadInitialData() {
            try {
                await checkSystemStatus();
                await loadModels();
                await loadInstructions();
                await loadChatHistory();
                console.log('✅ Initial data and chat history loaded');
            } catch (error) {
                console.error('❌ Failed to load initial data:', error);
                showNotification('Some features may not work properly', 'warning');
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                console.log('📊 System status:', status);
            } catch (error) {
                console.error('❌ Status check failed:', error);
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                console.log('🤖 Current model:', data.current_model);
            } catch (error) {
                console.error('❌ Models loading failed:', error);
            }
        }

        async function loadInstructions() {
            try {
                const response = await fetch('/api/instructions');
                const data = await response.json();
                console.log('✅ Instructions loaded');
            } catch (error) {
                console.error('❌ Instructions loading failed:', error);
                showNotification('Failed to load AI instructions', 'warning');
            }
        }

        function loadChatHistory() {
            try {
                console.log('📂 Loading chat history from localStorage...');
                
                // Check all localStorage keys
                console.log('🔍 All localStorage keys:', Object.keys(localStorage));
                
                const savedHistory = localStorage.getItem('chatHistory');
                console.log('🔍 Raw localStorage content for chatHistory:', savedHistory);
                
                if (savedHistory) {
                    console.log('📂 Found saved history in localStorage');
                    console.log('🔍 Length of savedHistory string:', savedHistory.length);
                    
                    const parsedHistory = JSON.parse(savedHistory);
                    console.log(`📂 Parsed ${parsedHistory.length} messages from localStorage`);
                    console.log('🔍 Parsed history type:', typeof parsedHistory);
                    console.log('🔍 Is array?', Array.isArray(parsedHistory));
                    
                    // Validate the parsed data
                    if (Array.isArray(parsedHistory)) {
                        conversationHistory = parsedHistory;
                        console.log(`✅ Loaded ${conversationHistory.length} messages into conversationHistory`);
                        
                        if (conversationHistory.length > 0) {
                            console.log(`📋 Loaded messages:`, conversationHistory.map((msg, i) => 
                                `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
                            ));
                        } else {
                            console.log('📋 No messages in loaded array');
                        }
                    } else {
                        console.error('❌ Parsed history is not an array:', typeof parsedHistory);
                        console.error('❌ Parsed history value:', parsedHistory);
                        conversationHistory = [];
                    }
                } else {
                    console.log('📂 No saved history found in localStorage');
                    console.log('🔍 localStorage.getItem("chatHistory") returned:', savedHistory);
                    conversationHistory = [];
                }
                
                console.log(`📊 Final conversationHistory length: ${conversationHistory.length}`);
                
            } catch (error) {
                console.error('❌ Error loading chat history:', error);
                console.error('❌ Error details:', error.message);
                conversationHistory = [];
            }
        }

        function renderChatHistory() {
            console.log(`🎨 renderChatHistory called with ${conversationHistory.length} messages`);
            
            // Hide welcome message
            elements.welcomeMessage.style.display = 'none';
            
            // Clear existing messages (except welcome)
            const existingMessages = elements.chatContainer.querySelectorAll('.message');
            console.log(`🗑️ Clearing ${existingMessages.length} existing messages from DOM`);
            existingMessages.forEach(msg => msg.remove());

            // Render all messages from history
            conversationHistory.forEach((message, index) => {
                console.log(`🎨 Rendering message ${index + 1}/${conversationHistory.length}:`, {
                    sender: message.sender,
                    contentLength: message.content.length,
                    timestamp: message.timestamp,
                    contentPreview: message.content.substring(0, 50) + '...'
                });
                renderMessage(message.sender, message.content, message.sources, message.timestamp);
            });

            // Verify rendering
            const renderedMessages = elements.chatContainer.querySelectorAll('.message');
            console.log(`✅ Rendering complete: ${renderedMessages.length} messages in DOM vs ${conversationHistory.length} in storage`);
            
            if (renderedMessages.length !== conversationHistory.length) {
                console.error(`❌ RENDERING MISMATCH: ${renderedMessages.length} in DOM vs ${conversationHistory.length} in storage`);
                console.log('🔍 Conversation history:', conversationHistory);
                console.log('🔍 Rendered messages:', Array.from(renderedMessages).map(el => el.textContent.substring(0, 50)));
            }

            scrollToBottom();
        }

        async function syncHistoryToServer() {
            try {
                console.log(`🔄 Syncing ${conversationHistory.length} messages to server`);
                
                // Check if server already has the same number of messages
                const serverResponse = await fetch('/api/chat/history');
                const serverData = await serverResponse.json();
                
                if (serverData.total_messages === conversationHistory.length) {
                    console.log('✅ Server already has the correct number of messages, skipping sync');
                    return;
                }
                
                console.log(`🔄 Server has ${serverData.total_messages} messages, we have ${conversationHistory.length}, syncing...`);
                
                // Clear server history first to prevent duplicates
                await fetch('/api/chat/history', { method: 'DELETE' });
                console.log('🗑️ Cleared server history');
                
                // Send each message to server with delay to prevent race conditions
                for (let i = 0; i < conversationHistory.length; i++) {
                    const message = conversationHistory[i];
                    console.log(`🔄 Syncing message ${i + 1}/${conversationHistory.length}:`, {
                        sender: message.sender,
                        contentLength: message.content.length,
                        id: message.id
                    });
                    
                    const response = await fetch('/api/chat/history', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(message)
                    });
                    
                    if (!response.ok) {
                        console.error(`❌ Failed to sync message ${i + 1}: ${response.status} ${response.statusText}`);
                    } else {
                        const result = await response.json();
                        console.log(`✅ Synced message ${i + 1}: server now has ${result.total_messages} messages`);
                    }
                    
                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Verify sync was successful
                const finalResponse = await fetch('/api/chat/history');
                const finalData = await finalResponse.json();
                console.log(`✅ Sync complete: server now has ${finalData.total_messages} messages`);
                
                if (finalData.total_messages !== conversationHistory.length) {
                    console.error(`❌ Sync verification failed: expected ${conversationHistory.length}, got ${finalData.total_messages}`);
                }
                
            } catch (error) {
                console.error('❌ Failed to sync history to server:', error);
            }
        }

        function handleInputChange() {
            const hasText = elements.messageInput.value.trim().length > 0;
            elements.sendButton.disabled = !hasText || isTyping;
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!elements.sendButton.disabled) {
                    sendMessage();
                }
            }
        }

        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message || isTyping) return;
            
            console.log(`📤 sendMessage called with: "${message}"`);
            console.log(`📊 conversationHistory before user message: ${conversationHistory.length} messages`);
            
            elements.welcomeMessage.style.display = 'none';
            
            // Add user message to history
            const userMessage = {
                id: generateMessageId(),
                sender: 'user',
                content: message,
                sources: [],
                timestamp: new Date().toISOString()
            };
            
            console.log(`👤 Adding user message to history:`, {
                id: userMessage.id,
                content: userMessage.content,
                timestamp: userMessage.timestamp
            });
            
            addMessageToHistory(userMessage);
            
            console.log(`📊 conversationHistory after user message: ${conversationHistory.length} messages`);
            console.log(`📋 Current conversationHistory:`, conversationHistory.map((msg, i) => 
                `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
            ));
            
            renderMessage('user', message);
            
            elements.messageInput.value = '';
            handleInputChange();
            showTyping();
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `question=${encodeURIComponent(message)}`
                });
                const data = await response.json();
                
                console.log(`📊 conversationHistory before assistant response: ${conversationHistory.length} messages`);
                
                if (data.error) {
                    const errorMessage = {
                        id: generateMessageId(),
                        sender: 'assistant',
                        content: `❌ ${data.error}`,
                        sources: [],
                        timestamp: new Date().toISOString()
                    };
                    addMessageToHistory(errorMessage);
                    renderMessage('assistant', `❌ ${data.error}`);
                } else {
                    const assistantMessage = {
                        id: generateMessageId(),
                        sender: 'assistant',
                        content: data.answer,
                        sources: data.sources || [],
                        timestamp: new Date().toISOString()
                    };
                    addMessageToHistory(assistantMessage);
                    renderMessage('assistant', data.answer, data.sources);
                }
                
                console.log(`📊 conversationHistory after assistant response: ${conversationHistory.length} messages`);
                console.log(`📋 Final conversationHistory:`, conversationHistory.map((msg, i) => 
                    `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
                ));
                
            } catch (error) {
                console.error('❌ Query failed:', error);
                const errorMessage = {
                    id: generateMessageId(),
                    sender: 'assistant',
                    content: '❌ Sorry, I encountered an error processing your question.',
                    sources: [],
                    timestamp: new Date().toISOString()
                };
                addMessageToHistory(errorMessage);
                renderMessage('assistant', '❌ Sorry, I encountered an error processing your question.');
            } finally {
                hideTyping();
            }
        }

        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function addMessageToHistory(message) {
            console.log(`💾 Adding message to history:`, {
                sender: message.sender,
                contentLength: message.content.length,
                timestamp: message.timestamp,
                id: message.id
            });
            
            console.log(`📊 Array before adding: ${conversationHistory.length} messages`);
            
            conversationHistory.push(message);
            
            console.log(`📊 Array after adding: ${conversationHistory.length} messages`);
            
            // Keep only last 50 messages
            if (conversationHistory.length > 50) {
                console.log(`🗑️ Trimming array from ${conversationHistory.length} to 50 messages`);
                conversationHistory = conversationHistory.slice(-50);
                console.log(`📊 Array after trimming: ${conversationHistory.length} messages`);
            }
            
            console.log(`📚 Conversation history now contains ${conversationHistory.length} messages`);
            
            // Save to localStorage
            try {
                console.log('💾 Attempting to save to localStorage...');
                console.log('💾 Data to save:', JSON.stringify(conversationHistory));
                console.log('💾 Data length:', JSON.stringify(conversationHistory).length);
                
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
                
                // Verify the save worked
                const savedData = localStorage.getItem('chatHistory');
                console.log('💾 Verification - saved data exists:', savedData !== null);
                console.log('💾 Verification - saved data length:', savedData ? savedData.length : 0);
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    console.log('💾 Verification - parsed data length:', parsedData.length);
                    console.log('💾 Verification - data matches:', parsedData.length === conversationHistory.length);
                }
                
                console.log('✅ Successfully saved to localStorage');
            } catch (e) {
                console.error('❌ Failed to save to localStorage:', e);
                console.error('❌ Error type:', e.name);
                console.error('❌ Error message:', e.message);
                
                // Check if localStorage is available
                console.log('🔍 localStorage available:', typeof localStorage !== 'undefined');
                console.log('🔍 localStorage quota exceeded:', e.name === 'QuotaExceededError');
                console.log('🔍 localStorage access denied:', e.name === 'SecurityError');
            }
            
            // Save to server
            saveMessageToServer(message);
        }

        async function saveMessageToServer(message) {
            try {
                console.log(`🌐 Saving message to server:`, {
                    sender: message.sender,
                    contentLength: message.content.length
                });
                
                const response = await fetch('/api/chat/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ Message saved to server: ${result.total_messages} total messages`);
                } else {
                    console.error(`❌ Server error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Failed to save message to server:', error);
            }
        }

        function renderMessage(sender, content, sources = [], timestamp = null) {
            try {
                console.log(`🎨 renderMessage called:`, {
                    sender: sender,
                    contentLength: content.length,
                    chatContainerExists: !!elements.chatContainer,
                    contentPreview: content.substring(0, 50) + '...'
                });
                
                if (!elements.chatContainer) {
                    console.error('❌ Chat container not found!');
                    return;
                }
                
                const messageTime = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const avatar = sender === 'user' ? 'You' : 'AI';
                const messageEl = document.createElement('div');
                messageEl.className = `message ${sender}`;
                
                let sourcesHtml = '';
                if (sources && sources.length > 0) {
                    sourcesHtml = `
                        <div class="message-sources">
                            <div class="sources-label">Sources:</div>
                            <ul class="source-list">
                                ${sources.map(source => `<li class="source-tag">${escapeHtml(source)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                messageEl.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">${formatMessage(content)}</div>
                            ${sourcesHtml}
                        </div>
                        <div class="message-timestamp">${messageTime}</div>
                    </div>
                `;
                
                console.log(`🎨 Appending message to chat container. Container has ${elements.chatContainer.children.length} children`);
                elements.chatContainer.appendChild(messageEl);
                console.log(`✅ Message appended successfully. Container now has ${elements.chatContainer.children.length} children`);
                
                scrollToBottom();
            } catch (error) {
                console.error('❌ Error in renderMessage:', error);
                console.error('❌ Message details:', { sender, contentLength: content.length, contentPreview: content.substring(0, 50) });
            }
        }

        function formatMessage(content) {
            return escapeHtml(content)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function showTyping() {
            isTyping = true;
            elements.typingIndicator.style.display = 'flex';
            elements.sendButton.disabled = true;
            scrollToBottom();
        }

        function hideTyping() {
            isTyping = false;
            elements.typingIndicator.style.display = 'none';
            handleInputChange();
        }

        function scrollToBottom() {
            setTimeout(() => {
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            }, 100);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add chat history management functions
        async function clearChatHistory() {
            if (!confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                return;
            }
            
            try {
                // Clear from server
                await fetch('/api/chat/history', { method: 'DELETE' });
                
                // Clear from localStorage
                localStorage.removeItem('chatHistory');
                
                // Clear from memory
                conversationHistory = [];
                
                // Reset UI
                elements.welcomeMessage.style.display = 'block';
                const existingMessages = elements.chatContainer.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());
                
                showNotification('Chat history cleared', 'success');
            } catch (error) {
                console.error('❌ Failed to clear chat history:', error);
                showNotification('Failed to clear chat history', 'error');
            }
        }

        async function exportChatHistory() {
            try {
                const response = await fetch('/api/chat/history/export');
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Chat history exported successfully', 'success');
            } catch (error) {
                console.error('❌ Failed to export chat history:', error);
                showNotification('Failed to export chat history', 'error');
            }
        }

        // Make functions globally available
        window.clearChatHistory = clearChatHistory;
        window.exportChatHistory = exportChatHistory;

        // Chat History Menu Functions
        function showChatHistoryMenu() {
            const menu = document.getElementById('chatHistoryMenu');
            menu.classList.toggle('show');
        }

        function hideChatHistoryMenu() {
            const menu = document.getElementById('chatHistoryMenu');
            menu.classList.remove('show');
        }

        async function importChatHistory() {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.history || !Array.isArray(data.history)) {
                        showNotification('Invalid chat history file format', 'error');
                        return;
                    }

                    // Import to server
                    const response = await fetch('/api/chat/history/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ history: data.history })
                    });

                    if (response.ok) {
                        // Reload chat history
                        await loadChatHistory();
                        showNotification('Chat history imported successfully', 'success');
                    } else {
                        throw new Error('Failed to import to server');
                    }
                } catch (error) {
                    console.error('❌ Failed to import chat history:', error);
                    showNotification('Failed to import chat history', 'error');
                }
            };
            input.click();
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('chatHistoryMenu');
            const button = e.target.closest('.chat-history-container');
            if (!button && menu.classList.contains('show')) {
                hideChatHistoryMenu();
            }
        });

        // Make import function globally available
        window.importChatHistory = importChatHistory;
        window.showChatHistoryMenu = showChatHistoryMenu;
        window.hideChatHistoryMenu = hideChatHistoryMenu;

        // Debug function to verify chat history state
        function debugChatHistory() {
            console.log('🔍 === CHAT HISTORY DEBUG ===');
            console.log(`📊 Total messages in memory: ${conversationHistory.length}`);
            
            const userMessages = conversationHistory.filter(msg => msg.sender === 'user');
            const assistantMessages = conversationHistory.filter(msg => msg.sender === 'assistant');
            
            console.log(`👤 User messages: ${userMessages.length}`);
            console.log(`🤖 Assistant messages: ${assistantMessages.length}`);
            
            if (userMessages.length > 0) {
                console.log('👤 User messages:');
                userMessages.forEach((msg, index) => {
                    console.log(`  ${index + 1}. "${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}" (${msg.timestamp})`);
                });
            }
            
            if (assistantMessages.length > 0) {
                console.log('🤖 Assistant messages:');
                assistantMessages.forEach((msg, index) => {
                    console.log(`  ${index + 1}. "${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}" (${msg.timestamp})`);
                });
            }
            
            console.log('🔍 === END DEBUG ===');
        }
        
        // Function to check conversationHistory array integrity
        function checkArrayIntegrity() {
            console.log('🔍 === ARRAY INTEGRITY CHECK ===');
            console.log(`Array length: ${conversationHistory.length}`);
            console.log(`Array type: ${Array.isArray(conversationHistory)}`);
            
            if (conversationHistory.length > 0) {
                console.log('Array contents:');
                conversationHistory.forEach((msg, index) => {
                    console.log(`  [${index}]: ${msg.sender} - "${msg.content.substring(0, 30)}..." (${msg.id})`);
                });
            }
            
            // Check for duplicates
            const ids = conversationHistory.map(msg => msg.id);
            const uniqueIds = new Set(ids);
            if (ids.length !== uniqueIds.size) {
                console.warn('⚠️ Duplicate message IDs detected!');
            }
            
            console.log('🔍 === END INTEGRITY CHECK ===');
        }
        
        // Function to check localStorage contents
        function checkLocalStorage() {
            console.log('🔍 === LOCALSTORAGE CHECK ===');
            try {
                const localHistory = localStorage.getItem('chatHistory');
                if (localHistory) {
                    const parsedHistory = JSON.parse(localHistory);
                    console.log(`📦 localStorage contains ${parsedHistory.length} messages`);
                    
                    parsedHistory.forEach((msg, index) => {
                        console.log(`  [${index}]: ${msg.sender} - "${msg.content.substring(0, 30)}..." (${msg.id})`);
                    });
                } else {
                    console.log('📦 localStorage is empty');
                }
            } catch (e) {
                console.error('❌ Error reading localStorage:', e);
            }
            console.log('🔍 === END LOCALSTORAGE CHECK ===');
        }
        
        // Test function to manually trigger rendering
        function testRender() {
            console.log('🧪 Testing render function...');
            console.log(`📊 conversationHistory length: ${conversationHistory.length}`);
            console.log(`🎯 chatContainer exists: ${!!elements.chatContainer}`);
            
            if (conversationHistory.length > 0) {
                console.log('🧪 Rendering first message as test...');
                const firstMessage = conversationHistory[0];
                renderMessage(firstMessage.sender, firstMessage.content, firstMessage.sources, firstMessage.timestamp);
            } else {
                console.log('🧪 No messages to render');
            }
        }
        
        // Function to identify missing messages
        function identifyMissingMessage() {
            console.log('🔍 === IDENTIFYING MISSING MESSAGE ===');
            
            const domMessages = elements.chatContainer.querySelectorAll('.message');
            console.log(`📊 Storage has ${conversationHistory.length} messages`);
            console.log(`📊 DOM has ${domMessages.length} messages`);
            
            if (domMessages.length === conversationHistory.length) {
                console.log('✅ No missing messages detected');
                return;
            }
            
            console.log('❌ Missing message detected!');
            console.log('📋 Storage messages:');
            conversationHistory.forEach((msg, index) => {
                console.log(`  ${index + 1}. [${msg.sender}] ${msg.content.substring(0, 50)}...`);
            });
            
            console.log('📋 DOM messages:');
            domMessages.forEach((msgEl, index) => {
                const sender = msgEl.classList.contains('user') ? 'user' : 'assistant';
                const content = msgEl.querySelector('.message-text')?.textContent || 'No content';
                console.log(`  ${index + 1}. [${sender}] ${content.substring(0, 50)}...`);
            });
            
            // Try to identify which message is missing
            const domTexts = Array.from(domMessages).map(el => 
                el.querySelector('.message-text')?.textContent || ''
            );
            
            const missingIndex = conversationHistory.findIndex((msg, index) => {
                const domText = domTexts[index];
                return !domText || !domText.includes(msg.content.substring(0, 20));
            });
            
            if (missingIndex !== -1) {
                console.log(`❌ Missing message is at index ${missingIndex}:`, conversationHistory[missingIndex]);
            }
            
            console.log('🔍 === END MISSING MESSAGE ANALYSIS ===');
        }
        
        // Monitor conversation history for unexpected changes
        function monitorConversationHistory() {
            console.log('🔍 === MONITORING CONVERSATION HISTORY ===');
            console.log(`📊 Current length: ${conversationHistory.length}`);
            console.log(`📋 Current messages:`, conversationHistory.map((msg, i) => 
                `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
            ));
            
            // Set up a periodic check to detect unexpected changes
            const originalLength = conversationHistory.length;
            const originalMessages = [...conversationHistory];
            
            setInterval(() => {
                if (conversationHistory.length !== originalLength) {
                    console.error(`❌ UNEXPECTED CHANGE DETECTED!`);
                    console.error(`📊 Length changed from ${originalLength} to ${conversationHistory.length}`);
                    console.error(`📋 Original messages:`, originalMessages.map((msg, i) => 
                        `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
                    ));
                    console.error(`📋 Current messages:`, conversationHistory.map((msg, i) => 
                        `${i + 1}. [${msg.sender}] ${msg.content.substring(0, 30)}...`
                    ));
                }
            }, 1000);
            
            console.log('🔍 === END MONITORING SETUP ===');
        }
        
        // Function to inspect and manage localStorage
        function inspectLocalStorage() {
            console.log('🔍 === INSPECTING LOCALSTORAGE ===');
            console.log('📊 Total localStorage items:', localStorage.length);
            console.log('🔑 All localStorage keys:', Object.keys(localStorage));
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`🔑 Key: "${key}"`);
                console.log(`📄 Value length: ${value ? value.length : 0}`);
                console.log(`📄 Value preview: ${value ? value.substring(0, 100) + '...' : 'null'}`);
                console.log('---');
            }
            
            // Check specifically for chatHistory
            const chatHistory = localStorage.getItem('chatHistory');
            console.log('🔍 chatHistory specific check:');
            console.log(`📄 Exists: ${chatHistory !== null}`);
            console.log(`📄 Length: ${chatHistory ? chatHistory.length : 0}`);
            console.log(`📄 Content: ${chatHistory || 'null'}`);
            
            console.log('🔍 === END LOCALSTORAGE INSPECTION ===');
        }
        
        // Function to clear localStorage and reset
        function clearLocalStorage() {
            console.log('🗑️ Clearing localStorage...');
            localStorage.clear();
            console.log('✅ localStorage cleared');
            conversationHistory = [];
            console.log('✅ conversationHistory reset');
            location.reload();
        }
        
        // Test localStorage functionality
        function testLocalStorage() {
            console.log('🧪 === TESTING LOCALSTORAGE ===');
            
            try {
                // Test 1: Basic localStorage access
                console.log('🧪 Test 1: Basic localStorage access');
                console.log('🔍 localStorage available:', typeof localStorage !== 'undefined');
                console.log('🔍 localStorage length:', localStorage.length);
                
                // Test 2: Write and read a simple value
                console.log('🧪 Test 2: Write and read simple value');
                localStorage.setItem('test_key', 'test_value');
                const testValue = localStorage.getItem('test_key');
                console.log('🔍 Test value written:', 'test_value');
                console.log('🔍 Test value read:', testValue);
                console.log('🔍 Test passed:', testValue === 'test_value');
                
                // Test 3: Write and read JSON
                console.log('🧪 Test 3: Write and read JSON');
                const testData = [{ id: 1, content: 'test' }];
                localStorage.setItem('test_json', JSON.stringify(testData));
                const testJson = localStorage.getItem('test_json');
                const parsedJson = JSON.parse(testJson);
                console.log('🔍 JSON written:', testData);
                console.log('🔍 JSON read:', parsedJson);
                console.log('🔍 JSON test passed:', JSON.stringify(testData) === JSON.stringify(parsedJson));
                
                // Test 4: Check current localStorage state
                console.log('🧪 Test 4: Current localStorage state');
                console.log('🔍 Total items:', localStorage.length);
                console.log('🔍 All keys:', Object.keys(localStorage));
                
                // Clean up test data
                localStorage.removeItem('test_key');
                localStorage.removeItem('test_json');
                console.log('🧪 Cleaned up test data');
                
                console.log('✅ All localStorage tests passed');
                
            } catch (error) {
                console.error('❌ localStorage test failed:', error);
                console.error('❌ Error type:', error.name);
                console.error('❌ Error message:', error.message);
            }
            
            console.log('🧪 === END LOCALSTORAGE TEST ===');
        }
        
        // Make debug functions available globally
        window.debugChatHistory = debugChatHistory;
        window.checkArrayIntegrity = checkArrayIntegrity;
        window.checkLocalStorage = checkLocalStorage;
        window.testRender = testRender;
        window.identifyMissingMessage = identifyMissingMessage;
        window.monitorConversationHistory = monitorConversationHistory;
        window.inspectLocalStorage = inspectLocalStorage;
        window.clearLocalStorage = clearLocalStorage;
        window.testLocalStorage = testLocalStorage;

        console.log('✅ Legal Document AI Assistant with persistent chat history initialized');
    </script>
    <script>
        // PDF viewer fallback logic
        document.addEventListener('DOMContentLoaded', function() {
            var iframe = document.getElementById('contractViewer');
            var placeholder = document.getElementById('contractPlaceholder');
            
            // Only run this code if the elements exist (contract viewer page)
            if (iframe && placeholder) {
                iframe.onload = function() {
                    if (iframe.contentDocument && iframe.contentDocument.body && iframe.contentDocument.body.innerText.match(/No contract uploaded yet|Error/)) {
                        iframe.style.display = 'none';
                        placeholder.style.display = 'block';
                    } else {
                        iframe.style.display = 'block';
                        placeholder.style.display = 'none';
                    }
                };
                iframe.onerror = function() {
                    iframe.style.display = 'none';
                    placeholder.style.display = 'block';
                };
            }
        });
    </script>
</body>
</html> 