<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ED19024 AI Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; overflow: hidden;
        }
        
        .app { height: 100vh; }
        
        .topbar {
            width: 100%; display: flex; justify-content: flex-end; align-items: center;
            background: rgba(255,255,255,0.1); padding: 16px 30px; position: relative;
        }
        
        .configure-link {
            color: #3b82f6; background: white; border-radius: 6px; padding: 8px 18px;
            font-size: 14px; font-weight: 500; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.2s;
        }
        
        .configure-link:hover {
            background: #e0e7ef;
        }
        
        .main-content {
            width: 100vw; height: calc(100vh - 56px); display: flex; flex-direction: column;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
        }
        
        .chat-header {
            padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.5);
        }
        
        .chat-title { font-size: 24px; font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .chat-subtitle { color: #6b7280; font-size: 14px; }
        
        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px 30px;
            display: flex; flex-direction: column; gap: 20px;
        }
        
        .welcome {
            text-align: center; color: #6b7280; margin-top: 50px;
        }
        
        .welcome h2 { color: #1f2937; margin-bottom: 10px; }
        
        .message {
            display: flex; gap: 15px; animation: fadeIn 0.3s ease;
        }
        
        .message.user { flex-direction: row-reverse; }
        
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px; flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
        }
        
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;
        }
        
        .message-content { flex: 1; max-width: calc(100% - 55px); }
        
        .message-bubble {
            background: white; border-radius: 18px; padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; margin-left: 60px;
        }
        
        .message-text { line-height: 1.5; word-wrap: break-word; }
        
        .message-sources {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .sources-label { font-size: 12px; color: #6b7280; font-weight: 500; margin-bottom: 8px; }
        
        .source-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .source-tag {
            background: rgba(59,130,246,0.1); color: #3b82f6; padding: 4px 8px;
            border-radius: 12px; font-size: 11px; font-weight: 500;
        }
        
        .message-timestamp {
            color: rgba(0,0,0,0.4); font-size: 11px; margin-top: 8px;
        }
        
        .message.user .message-timestamp { color: rgba(255,255,255,0.7); }
        
        .input-container {
            padding: 20px 30px; border-top: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
        }
        
        .input-wrapper { position: relative; max-width: 800px; margin: 0 auto; }
        
        .message-input {
            width: 100%; border: 2px solid rgba(0,0,0,0.1); border-radius: 25px;
            padding: 15px 60px 15px 20px; font-size: 16px; background: white;
            outline: none; resize: none; min-height: 50px; max-height: 120px;
            font-family: inherit;
        }
        
        .message-input:focus {
            border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .send-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 40px; height: 40px; border: none; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        
        .send-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .typing {
            display: none; align-items: center; gap: 8px; color: #6b7280;
            font-style: italic; margin-top: 10px;
        }
        
        .typing-dots { display: flex; gap: 4px; }
        
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #6b7280;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 12px 20px;
            border-radius: 8px; z-index: 10000; color: white; font-size: 14px;
            animation: slideIn 0.3s ease; max-width: 300px;
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        .notification.info { background: #3b82f6; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .source-list {
            margin: 8px 0 0 0;
            padding-left: 18px;
            color: #3b82f6;
            font-size: 12px;
        }
        .source-list li {
            margin-bottom: 2px;
            list-style-type: disc;
            background: none;
            display: list-item;
            padding: 0;
            border-radius: 0;
        }
        .contract-viewer-section {
            width: 100%; max-width: 900px; margin: 0 auto 18px auto; display: flex; flex-direction: column; align-items: center;
        }
        .contract-viewer-label {
            color: #1f2937; font-size: 15px; font-weight: 600; margin-bottom: 6px; margin-top: 10px;
        }
        .contract-viewer {
            width: 100%;
            height: 600px;
            min-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            margin-bottom: 8px;
            display: block;
        }
        .contract-placeholder {
            color: #ef4444; font-size: 15px; text-align: center; margin: 20px 0;
        }
        .contract-viewer-top {
            width: 100vw;
            max-width: 100vw;
            margin: 0 auto 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 12px rgba(0,0,0,0.03);
            padding: 0 0 0 0;
        }
        @media (max-width: 900px) {
            .contract-viewer-top { max-width: 100vw; }
            .contract-viewer { height: 400px; }
        }
        .contract-link {
            color: #3b82f6; background: white; border-radius: 6px; padding: 8px 18px;
            font-size: 14px; font-weight: 500; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.2s; margin-right: 12px;
        }
        .contract-link:hover {
            background: #e0e7ef;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <a href="/contract" class="contract-link">üìÑ View Contract</a>
            <a href="/configure" class="configure-link">‚öôÔ∏è Configure</a>
        </div>
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title">ED19024 AI Assistant</div>
                <div class="chat-subtitle">Ask questions about ED19024</div>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="welcome" id="welcomeMessage">
                    <h2>‚öñÔ∏è Welcome to your ED19024 AI Assistant</h2>
                    <p>Upload ED19024 using the Configure page and start asking questions about their content.</p>
                </div>
            </div>
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="Ask a question about your legal documents..." 
                              rows="1"></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                        </svg>
                    </button>
                </div>
                <div class="typing" id="typingIndicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Only chat-related JS below. Sidebar/document logic removed.
        console.log('‚öñÔ∏è Starting Legal Document AI Assistant...');

        // Global variables
        let isTyping = false;
        let conversationHistory = [];

        // DOM elements
        let elements = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã DOM loaded, initializing...');
            initializeApp();
        });

        function initializeApp() {
            try {
                // Get DOM elements
                elements = {
                    chatContainer: document.getElementById('chatContainer'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    welcomeMessage: document.getElementById('welcomeMessage'),
                    typingIndicator: document.getElementById('typingIndicator'),
                };
                console.log('‚úÖ Elements found');
                bindEvents();
                console.log('‚úÖ Events bound');
                loadInitialData();
                console.log('‚úÖ Loading initial data...');
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showNotification('Failed to initialize app: ' + error.message, 'error');
            }
        }

        function bindEvents() {
            elements.messageInput.addEventListener('input', handleInputChange);
            elements.messageInput.addEventListener('keydown', handleKeyDown);
            elements.sendButton.addEventListener('click', sendMessage);
        }

        async function loadInitialData() {
            try {
                await checkSystemStatus();
                await loadModels();
                await loadInstructions();
                console.log('‚úÖ Initial data loaded');
            } catch (error) {
                console.error('‚ùå Failed to load initial data:', error);
                showNotification('Some features may not work properly', 'warning');
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                console.log('üìä System status:', status);
            } catch (error) {
                console.error('‚ùå Status check failed:', error);
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                console.log('ü§ñ Current model:', data.current_model);
            } catch (error) {
                console.error('‚ùå Models loading failed:', error);
            }
        }

        async function loadInstructions() {
            try {
                const response = await fetch('/api/instructions');
                const data = await response.json();
                console.log('‚úÖ Instructions loaded');
            } catch (error) {
                console.error('‚ùå Instructions loading failed:', error);
                showNotification('Failed to load AI instructions', 'warning');
            }
        }

        function handleInputChange() {
            const hasText = elements.messageInput.value.trim().length > 0;
            elements.sendButton.disabled = !hasText || isTyping;
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!elements.sendButton.disabled) {
                    sendMessage();
                }
            }
        }

        async function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message || isTyping) return;
            elements.welcomeMessage.style.display = 'none';
            addMessage('user', message);
            elements.messageInput.value = '';
            handleInputChange();
            showTyping();
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `question=${encodeURIComponent(message)}`
                });
                const data = await response.json();
                if (data.error) {
                    addMessage('assistant', `‚ùå ${data.error}`);
                } else {
                    addMessage('assistant', data.answer, data.sources);
                }
            } catch (error) {
                console.error('‚ùå Query failed:', error);
                addMessage('assistant', '‚ùå Sorry, I encountered an error processing your question.');
            } finally {
                hideTyping();
            }
        }

        function addMessage(sender, content, sources = []) {
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const avatar = sender === 'user' ? 'You' : 'AI';
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="message-sources">
                        <div class="sources-label">Sources:</div>
                        <ul class="source-list">
                            ${sources.map(source => `<li class="source-tag">${escapeHtml(source)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            messageEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="message-text">${formatMessage(content)}</div>
                        ${sourcesHtml}
                    </div>
                    <div class="message-timestamp">${timestamp}</div>
                </div>
            `;
            elements.chatContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function formatMessage(content) {
            return escapeHtml(content)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function showTyping() {
            isTyping = true;
            elements.typingIndicator.style.display = 'flex';
            elements.sendButton.disabled = true;
            scrollToBottom();
        }

        function hideTyping() {
            isTyping = false;
            elements.typingIndicator.style.display = 'none';
            handleInputChange();
        }

        function scrollToBottom() {
            setTimeout(() => {
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            }, 100);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('‚úÖ Legal Document AI Assistant initialized');
    </script>
    <script>
        // PDF viewer fallback logic
        document.addEventListener('DOMContentLoaded', function() {
            var iframe = document.getElementById('contractViewer');
            var placeholder = document.getElementById('contractPlaceholder');
            iframe.onload = function() {
                if (iframe.contentDocument && iframe.contentDocument.body && iframe.contentDocument.body.innerText.match(/No contract uploaded yet|Error/)) {
                    iframe.style.display = 'none';
                    placeholder.style.display = 'block';
                } else {
                    iframe.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            };
            iframe.onerror = function() {
                iframe.style.display = 'none';
                placeholder.style.display = 'block';
            };
        });
    </script>
</body>
</html> 